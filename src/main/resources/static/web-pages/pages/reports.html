<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - Event Management System</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Custom CSS -->
    <style>
        body {
            padding-top: 56px;
            background-color: #f8f9fa;
            font-family: sans-serif;
        }
        .sidebar {
            position: fixed;
            top: 56px;
            bottom: 0;
            left: 0;
            z-index: 100;
            padding: 20px 0;
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
            background-color: #343a40;
            width: 220px;
        }
        .sidebar .nav-link {
            font-weight: 500;
            color: rgba(255, 255, 255, .65);
            padding: .75rem 1.25rem;
            display: flex;
            align-items: center;
        }
        .sidebar .nav-link i {
            margin-right: 10px;
            font-size: 1.1rem;
            width: 20px;
            text-align: center;
        }
        .sidebar .nav-link:hover {
            color: #fff;
            background-color: #343a40;
        }
        .sidebar .nav-link.active {
            color: #fff;
            background-color: #0d6efd;
        }
        .main-content {
            margin-left: 220px;
            padding: 25px;
            min-height: calc(100vh - 56px);
        }
        .navbar {
            box-shadow: 0 2px 3px rgba(0,0,0,.1);
            z-index: 101;
        }
        h2, h4 {
            color: #343a40;
            font-weight: 600;
            margin-bottom: 1.25rem;
        }
        .section-card {
            background-color: #fff;
            border: none;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,.05);
        }
        .section-card .card-header {
            background-color: transparent;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            color: #343a40;
            padding: 1rem 1.25rem;
            font-size: 1rem;
        }
        .section-card .card-body {
             padding: 1.25rem;
        }
        .stat-card {
            background-color: #ffffff;
            border: none;
            padding: 20px;
            margin-bottom: 1.5rem;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,.05);
        }
        .stat-card h5 {
            color: #6c757d;
            font-size: 0.8rem;
            margin-bottom: 5px;
            text-transform: uppercase;
            font-weight: 600;
        }
        .stat-card h3 {
            font-size: 1.75rem;
            font-weight: 700;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .top-event-item {
            padding: 10px 15px;
            border-bottom: 1px solid #f1f3f5;
        }
        .top-event-item:last-child {
            border-bottom: none;
        }
        .badge-counter {
            font-size: 1.1rem;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-calendar-check"></i> Event Management System
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <span class="navbar-text me-3" id="username">
                            Welcome, Organizer!
                        </span>
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-outline-light btn-sm" onclick="logout()">Logout</button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a href="dashboard.html" class="nav-link" id="dashboard-link">
                                <i class="bi bi-speedometer2"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="myevents.html" class="nav-link" id="my-events-link">
                                <i class="bi bi-calendar-event"></i> My Events
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="create-event.html" class="nav-link" id="create-event-link">
                                <i class="bi bi-plus-circle"></i> Add New Event
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="reports.html" class="nav-link active" id="reports-link">
                                <i class="bi bi-file-earmark-text"></i> Reports
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="queries.html" class="nav-link" id="queries-link">
                                <i class="bi bi-question-circle"></i> Queries
                                <span class="badge bg-danger rounded-pill ms-1" id="queries-badge">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="feedback.html" class="nav-link" id="feedback-link">
                                <i class="bi bi-chat-left-text"></i> Feedback
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>
            
            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h2><i class="bi bi-file-earmark-text"></i> Reports & Analytics</h2>
                    <div>
                        <button class="btn btn-primary" id="refreshData">
                            <i class="bi bi-arrow-clockwise"></i> Refresh Data
                        </button>
                        </button>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="section-card">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-2">
                                        <label for="dateRangeSelect" class="form-label mb-0"><i class="bi bi-calendar3"></i> Date Range:</label>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="dateRangeSelect">
                                            <option value="all" selected>All Time</option>
                                            <option value="30">Last 30 Days</option>
                                            <option value="90">Last 90 Days</option>
                                            <option value="180">Last 6 Months</option>
                                            <option value="365">Last Year</option>
                                            <option value="custom">Custom Range</option>
                                        </select>
                                    </div>
                                    <div class="col-md-7" id="customDateRange" style="display: none;">
                                        <div class="row">
                                            <div class="col-md-5">
                                                <input type="date" class="form-control" id="startDate">
                                            </div>
                                            <div class="col-md-1 text-center">to</div>
                                            <div class="col-md-5">
                                                <input type="date" class="form-control" id="endDate">
                                            </div>
                                            <div class="col-md-1">
                                                <button class="btn btn-primary" id="applyCustomRange">Apply</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Stats Row -->
                <div class="row">
                    <div class="col-md-3 col-sm-6">
                        <div class="stat-card">
                            <div class="text-primary mb-2">
                                <i class="bi bi-calendar3 fs-3"></i>
                            </div>
                            <h3 id="totalEvents">0</h3>
                            <h5>Total Events</h5>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="stat-card">
                            <div class="text-success mb-2">
                                <i class="bi bi-people fs-3"></i>
                            </div>
                            <h3 id="totalRegistrations">0</h3>
                            <h5>Total Registrations</h5>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="stat-card">
                            <div class="text-info mb-2">
                                <i class="bi bi-person-check fs-3"></i>
                            </div>
                            <h3 id="avgAttendance">0</h3>
                            <h5>Avg. Attendance</h5>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="stat-card">
                            <div class="text-warning mb-2">
                                <i class="bi bi-percent fs-3"></i>
                            </div>
                            <h3 id="capacityUtilization">0%</h3>
                            <h5>Capacity Utilization</h5>
                        </div>
                    </div>
                </div>
                
                <!-- Category Distribution and Time Trend Charts -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="section-card">
                            <div class="card-header">
                                <i class="bi bi-pie-chart"></i> Event Category Distribution
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="categoryChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="section-card">
                            <div class="card-header">
                                <i class="bi bi-graph-up"></i> Event Timeline
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="timelineChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Top Performing Events -->
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="section-card">
                            <div class="card-header">
                                <i class="bi bi-trophy"></i> Top Performing Events
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Event</th>
                                                <th>Date</th>
                                                <th>Category</th>
                                                <th>Registrations</th>
                                                <th>Capacity</th>
                                                <th>Fill Rate</th>
                                            </tr>
                                        </thead>
                                        <tbody id="topEventsTable">
                                            <tr><td colspan="7" class="text-center text-muted p-4">Loading top events...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Attendance By Category Table -->
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="section-card">
                            <div class="card-header">
                                <i class="bi bi-table"></i> Category Performance
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Category</th>
                                                <th>Total Events</th>
                                                <th>Total Registrations</th>
                                                <th>Avg. Registrations</th>
                                                <th>% of All Events</th>
                                            </tr>
                                        </thead>
                                        <tbody id="categoryTable">
                                            <tr><td colspan="5" class="text-center text-muted p-4">Loading category data...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Footer -->
                <footer class="pt-4 my-4 text-muted border-top">
                    <p class="small text-center">© 2025 Event Management System. All rights reserved.</p>
                </footer>
            </main>
        </div>
    </div>

    <!-- Bootstrap and JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in
            if (!localStorage.getItem('token')) {
                window.location.href = '../login.html';
                return;
            }
            
            // Set user info - Same username display logic from dashboard
            let userName = "Organizer"; // Default fallback
            
            try {
                // Try to get from token first
                const token = localStorage.getItem('token');
                
                // Decode token
                const decoded = decodeJWT(token);
                
                // Check multiple possible field names for username
                if (decoded && (decoded.username || decoded.name || decoded.sub)) {
                    userName = decoded.username || decoded.name || decoded.sub;
                    document.getElementById('username').textContent = 'Welcome, ' + userName + '!';
                } else {
                    // If username not in token, fetch from API
                    const userId = getUserId();
                    
                    if (userId) {
                        fetch(`http://localhost:8080/api/users/${userId}`, {
                            headers: {
                                'Authorization': getAuthorization()
                            }
                        })
                        .then(response => {
                            if (!response.ok) throw new Error('Failed to fetch user data');
                            return response.json();
                        })
                        .then(userData => {
                            if (userData && userData.name) {
                                userName = userData.name;
                                document.getElementById('username').textContent = 'Welcome, ' + userName + '!';
                            }
                        })
                        .catch(error => {
                            console.error("Error fetching user data:", error);
                        });
                    }
                }
            } catch (error) {
                console.error("Error processing user information:", error);
                document.getElementById('username').textContent = 'Welcome, Organizer!';
            }
              // Check if user is an organizer
            const userType = getUserType();
            if (userType !== 'ORGANIZER') {
                window.location.href = 'home.html';
                return;
            }
            
            // Initialize date range
            initDateRangeSelector();
            
            // Define the organizerId globally for use in all functions
            window.organizerId = getUserId();
            if (!window.organizerId) {
                showError("Could not determine organizer ID. Please log in again.");
                return;
            }
            
            // Load reports data
            loadReportsData();
            
            // Add event listeners
            document.getElementById('refreshData').addEventListener('click', loadReportsData);
            
            // Fetch pending queries count for badge
            fetchQueryCount();
        });
        
        // Global chart references for updating
        let categoryChart = null;
        let timelineChart = null;
        
        function initDateRangeSelector() {
            document.getElementById('dateRangeSelect').addEventListener('change', function() {
                const customRangeDiv = document.getElementById('customDateRange');
                if (this.value === 'custom') {
                    customRangeDiv.style.display = 'block';
                    
                    // Set default date range for custom selection (last 30 days)
                    const today = new Date();
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(today.getDate() - 30);
                    
                    document.getElementById('startDate').value = formatDateForInput(thirtyDaysAgo);
                    document.getElementById('endDate').value = formatDateForInput(today);
                } else {
                    customRangeDiv.style.display = 'none';
                    loadReportsData();
                }
            });
            
            document.getElementById('applyCustomRange').addEventListener('click', loadReportsData);
        }
        
        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function getDateRange() {
            const rangeType = document.getElementById('dateRangeSelect').value;
            const today = new Date();
            let startDate = null;
            
            switch (rangeType) {
                case 'all':
                    // All time - no date filtering
                    return { start: null, end: null };
                case '30':
                    startDate = new Date();
                    startDate.setDate(today.getDate() - 30);
                    break;
                case '90':
                    startDate = new Date();
                    startDate.setDate(today.getDate() - 90);
                    break;
                case '180':
                    startDate = new Date();
                    startDate.setDate(today.getDate() - 180);
                    break;
                case '365':
                    startDate = new Date();
                    startDate.setDate(today.getDate() - 365);
                    break;
                case 'custom':
                    const customStart = document.getElementById('startDate').value;
                    const customEnd = document.getElementById('endDate').value;
                    return {
                        start: customStart ? new Date(customStart) : null,
                        end: customEnd ? new Date(customEnd) : today
                    };
            }
            
            return { start: startDate, end: today };
        }
        
        function loadReportsData() {
            // Show loading indicators
            document.querySelectorAll('.card-body').forEach(container => {
                const loadingSpinner = document.createElement('div');
                loadingSpinner.className = 'text-center loading-spinner';
                loadingSpinner.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';
                container.querySelector('table, canvas')?.insertAdjacentElement('beforebegin', loadingSpinner);
            });
            
            // Clear previous errors
            document.querySelectorAll('.alert').forEach(alert => {
                alert.remove();
            });
            
            // Get selected date range
            const dateRange = getDateRange();
            
            // Fetch events and registrations
            Promise.all([
                fetchEvents(window.organizerId), // Use the global organizerId
                fetchRegistrations()
            ])
            .then(([events, registrations]) => {
                // Filter events by date range if specified
                let filteredEvents = events;
                if (dateRange.start) {
                    filteredEvents = events.filter(event => {
                        const eventDate = new Date(event.date);
                        return eventDate >= dateRange.start && eventDate <= dateRange.end;
                    });
                }
                
                // Process data for reports
                processAndDisplayReports(filteredEvents, registrations);
                
                // Hide loading indicators
                document.querySelectorAll('.loading-spinner').forEach(spinner => {
                    spinner.remove();
                });
            })
            .catch(error => {
                console.error("Error loading report data:", error);
                showError(`Error loading report data: ${error.message}`);
                
                // Hide loading indicators
                document.querySelectorAll('.loading-spinner').forEach(spinner => {
                    spinner.remove();
                });
            });
        }
        
        function fetchEvents(organizerId) {
            return fetch(`http://localhost:8080/api/events/organizer/${organizerId}`, {
                headers: { 'Authorization': getAuthorization() }
            })
            .then(response => {
                if (!response.ok) throw new Error(`Failed to fetch events: ${response.status}`);
                return response.json();
            });
        }
        
        function fetchRegistrations() {
            return fetch(`http://localhost:8080/api/registrations`, {
                headers: { 'Authorization': getAuthorization() }
            })
            .then(response => {
                if (!response.ok) {
                    // If we can't get registrations, return empty array
                    console.warn("Could not fetch registrations, using empty array");
                    return [];
                }
                return response.json();
            });
        }
        
        function processAndDisplayReports(events, registrations) {
            if (!events.length) {
                showError("No events found in the selected time period.");
                return;
            }
            
            // Calculate key metrics
            const totalEvents = events.length;
            
            // Filter registrations for only our events
            const eventIds = events.map(e => e.eventId);
            const relevantRegistrations = registrations.filter(r => 
                r.event && eventIds.includes(r.event.eventId));
                
            const totalRegs = relevantRegistrations.length;
            
            // Avg attendance per event 
            const avgAttendance = totalEvents > 0 ? (totalRegs / totalEvents).toFixed(1) : 0;
            
            // Calculate capacity utilization
            let totalCapacity = 0;
            events.forEach(event => {
                if (event.capacity && !isNaN(event.capacity)) {
                    totalCapacity += event.capacity;
                }
            });
            
            const capacityUtilization = totalCapacity > 0 
                ? Math.round((totalRegs / totalCapacity) * 100) 
                : 0;
            
            // Update summary stats
            document.getElementById('totalEvents').textContent = totalEvents;
            document.getElementById('totalRegistrations').textContent = totalRegs;
            document.getElementById('avgAttendance').textContent = avgAttendance;
            document.getElementById('capacityUtilization').textContent = capacityUtilization + '%';
            
            // Process event data by category
            const categoryCounts = {};
            const categoryRegistrations = {};
            
            events.forEach(event => {
                const category = event.category || 'Uncategorized';
                // Count events by category
                categoryCounts[category] = (categoryCounts[category] || 0) + 1;
                
                // Initialize registration counter if not exists
                if (!categoryRegistrations[category]) {
                    categoryRegistrations[category] = 0;
                }
                
                // Count registrations for this event
                const eventRegs = relevantRegistrations.filter(
                    r => r.event && r.event.eventId === event.eventId
                ).length;
                
                // Add to category total
                categoryRegistrations[category] += eventRegs;
            });
            
            // Create and update charts
            createCategoryChart(categoryCounts);
            createTimelineChart(events, relevantRegistrations);
            
            // Create top events table
            createTopEventsTable(events, relevantRegistrations);
            
            // Create category performance table
            createCategoryTable(categoryCounts, categoryRegistrations, totalEvents);
        }
        
        function createCategoryChart(categoryCounts) {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            // Prepare data for chart
            const categories = Object.keys(categoryCounts);
            const counts = Object.values(categoryCounts);
            
            // Generate colors
            const backgroundColors = [
                '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', 
                '#6f42c1', '#fd7e14', '#20c997', '#6610f2', '#17a2b8'
            ];
            
            // If chart already exists, destroy it
            if (categoryChart) {
                categoryChart.destroy();
            }
            
            // Create new chart
            categoryChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: categories,
                    datasets: [{
                        data: counts,
                        backgroundColor: backgroundColors.slice(0, categories.length),
                        hoverOffset: 4
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        title: {
                            display: true,
                            text: 'Events by Category'
                        }
                    }
                }
            });
        }
        
        function createTimelineChart(events, registrations) {
            const ctx = document.getElementById('timelineChart').getContext('2d');
            
            // Sort events by date
            events.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Group events by month
            const eventsByMonth = {};
            const regsByMonth = {};
            
            events.forEach(event => {
                const date = new Date(event.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                // Count events
                eventsByMonth[monthKey] = (eventsByMonth[monthKey] || 0) + 1;
                
                // Initialize registrations counter
                if (!regsByMonth[monthKey]) {
                    regsByMonth[monthKey] = 0;
                }
                
                // Count registrations for this event
                const eventRegs = registrations.filter(
                    r => r.event && r.event.eventId === event.eventId
                ).length;
                
                // Add to monthly total
                regsByMonth[monthKey] += eventRegs;
            });
            
            // Get all unique months from both objects
            const allMonths = [...new Set([
                ...Object.keys(eventsByMonth),
                ...Object.keys(regsByMonth)
            ])].sort();
            
            // Format month labels
            const monthLabels = allMonths.map(monthKey => {
                const [year, month] = monthKey.split('-');
                const date = new Date(parseInt(year), parseInt(month) - 1, 1);
                return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            });
            
            // Prepare data arrays
            const eventCounts = allMonths.map(month => eventsByMonth[month] || 0);
            const regCounts = allMonths.map(month => regsByMonth[month] || 0);
            
            // If chart already exists, destroy it
            if (timelineChart) {
                timelineChart.destroy();
            }
            
            // Create new chart
            timelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: [
                        {
                            label: 'Events',
                            data: eventCounts,
                            borderColor: '#4e73df',
                            backgroundColor: 'rgba(78, 115, 223, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1
                        },
                        {
                            label: 'Registrations',
                            data: regCounts,
                            borderColor: '#1cc88a',
                            backgroundColor: 'rgba(28, 200, 138, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1
                        }
                    ]
                },                options: {
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Events & Registrations Timeline'
                        }
                    }
                }
            });
        }
        
        function createTopEventsTable(events, registrations) {
            const tableBody = document.getElementById('topEventsTable');
            tableBody.innerHTML = '';
            
            // Calculate registrations per event
            const eventStats = events.map(event => {
                const regs = registrations.filter(r => 
                    r.event && r.event.eventId === event.eventId
                ).length;
                
                const capacity = event.capacity || 0;
                const fillRate = capacity > 0 ? (regs / capacity) * 100 : 0;
                
                return {
                    event: event,
                    registrations: regs,
                    capacity: capacity,
                    fillRate: fillRate
                };
            });
            
            // Sort by registrations (descending)
            eventStats.sort((a, b) => b.registrations - a.registrations);
            
            // Take top 10
            const topEvents = eventStats.slice(0, 10);
            
            if (topEvents.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No event data available</td></tr>';
                return;
            }
            
            // Add rows to table
            topEvents.forEach((item, index) => {
                const event = item.event;
                const row = document.createElement('tr');
                
                // Format date nicely
                const eventDate = new Date(event.date);
                const formattedDate = eventDate.toLocaleDateString('en-US', {
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric'
                });
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${event.title}</td>
                    <td>${formattedDate}</td>
                    <td>${event.category || 'Uncategorized'}</td>
                    <td>${item.registrations}</td>
                    <td>${item.capacity || 'Unlimited'}</td>
                    <td>
                        <div class="progress" style="height: 15px;">
                            <div class="progress-bar bg-success" role="progressbar" 
                                style="width: ${Math.min(item.fillRate, 100)}%" 
                                aria-valuenow="${item.fillRate.toFixed(0)}" 
                                aria-valuemin="0" aria-valuemax="100">
                                ${item.fillRate.toFixed(0)}%
                            </div>
                        </div>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        function createCategoryTable(categoryCounts, categoryRegistrations, totalEvents) {
            const tableBody = document.getElementById('categoryTable');
            tableBody.innerHTML = '';
            
            // Calculate metrics for each category
            const categoryStats = Object.keys(categoryCounts).map(category => {
                const eventCount = categoryCounts[category];
                const regCount = categoryRegistrations[category] || 0;
                const avgRegs = eventCount > 0 ? (regCount / eventCount).toFixed(1) : 0;
                const percentOfTotal = ((eventCount / totalEvents) * 100).toFixed(1);
                
                return {
                    category: category,
                    eventCount: eventCount,
                    regCount: regCount,
                    avgRegs: avgRegs,
                    percentOfTotal: percentOfTotal
                };
            });
            
            // Sort by event count (descending)
            categoryStats.sort((a, b) => b.eventCount - a.eventCount);
            
            if (categoryStats.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No category data available</td></tr>';
                return;
            }
            
            // Add rows to table
            categoryStats.forEach(stat => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${stat.category}</td>
                    <td>${stat.eventCount}</td>
                    <td>${stat.regCount}</td>
                    <td>${stat.avgRegs}</td>
                    <td>${stat.percentOfTotal}%</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function fetchQueryCount() {
            const organizerId = getUserId();
            
            fetch(`http://localhost:8080/api/queries/pending/organizer/${organizerId}`, {
                headers: {
                    'Authorization': getAuthorization()
                }
            })
            .then(response => {
                if (!response.ok) {
                    return [];
                }
                return response.json();
            })
            .then(queries => {
                const badge = document.getElementById('queries-badge');
                if (queries.length > 0) {
                    badge.textContent = queries.length;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error fetching queries:', error);
                document.getElementById('queries-badge').style.display = 'none';
            });
        }
        
        function showError(message) {
            const mainContent = document.querySelector('.main-content');
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // Insert after heading
            const heading = mainContent.querySelector('h2').parentNode.parentNode;
            mainContent.insertBefore(alertDiv, heading.nextSibling);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                alertDiv.querySelector('.btn-close').click();
            }, 5000);
        }
        
        // Helper functions from your existing code
        function getUserId() {
            try {
                const token = localStorage.getItem('token');
                const decoded = decodeJWT(token);
                
                // For the dashboard, let's prefer the email if available
                if (decoded.email) {
                    return decoded.email;
                }
                
                // Next try to get numeric userId
                if (decoded.userId && !isNaN(decoded.userId)) {
                    return decoded.userId;
                }
                
                if (decoded.userid && !isNaN(decoded.userid)) {
                    return decoded.userid;
                }
                
                // If we have a sub field (often contains email)
                if (decoded.sub) {
                    return decoded.sub;
                }
                
                return null;
            } catch (error) {
                console.error('Error getting user ID:', error);
                return null;
            }
        }
        
        function logout() {
            localStorage.removeItem('token');
            window.location.href = '../login.html';
        }
    </script>
</body>
</html>
